<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>í€´ì¦ˆ ì‹œìŠ¤í…œ (ì‚¬ì§„ë¬¸ì œ í¬í•¨)</title>
<style>
/* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
:root{
  --gap: 10px;
  --radius: 8px;
  --accent: #68a0ff;
}
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 12px;
  background: #fafafa;
  color: #111;
  -webkit-font-smoothing:antialiased;
}
.container {
  max-width: 900px;
  margin: 0 auto;
}

/* í—¤ë” */
h1 {
  margin: 6px 0 12px;
  font-size: 1.4rem;
  text-align: left;
}

/* ì»¨íŠ¸ë¡¤ */
.controls {
  display: flex;
  gap: var(--gap);
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 8px;
}
.controls select,
.controls button,
.controls input[type="file"] {
  padding: 10px;
  font-size: 1rem;
  border-radius: 8px;
  border: 1px solid #ddd;
  background: white;
}

/* ë©”ë‰´ ë°” */
.menuBar {
  margin-top: 6px;
  margin-bottom: 10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* ìƒíƒœ */
#statusBar {
  margin-top: 8px;
  font-weight: bold;
  font-size: 0.95rem;
}

/* ë¬¸ì œ ì˜ì—­ */
#questionArea {
  margin-top: 16px;
  background: white;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}

/* ì´ë¯¸ì§€ ë¬¸ì œ ìŠ¤íƒ€ì¼ */
#questionImage {
  display: block;
  width: 100%;
  max-height: 360px;
  object-fit: contain;
  border-radius: 8px;
  margin: 12px 0;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

/* ë³´ê¸° ì¹´ë“œ */
.question-card {
  border: 1px solid #ddd;
  background: white;
  padding: 12px;
  margin-top: 8px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.12s, transform 0.08s;
  font-size: 1rem;
  text-align: left;
}
.question-card:hover { background: #f7f9ff; transform: translateY(-2px); }

/* ë‹µ í‘œì‹œ ë°•ìŠ¤ */
#answerBox {
  margin-top: 12px;
  padding: 12px;
  border-radius: 10px;
  background: white;
  border: 1px solid #e8e8e8;
  min-height: 120px;
  /* ìŠ¤í¬ë¡¤ ì—†ì´ í•œ ë²ˆì— ë³´ì´ë„ë¡ ê¸°ë³¸ ë†’ì´ëŠ” ì¶©ë¶„íˆ ê°–ì¶”ë˜, ë‚´ìš©ì— ë”°ë¼ ëŠ˜ì–´ë‚¨ */
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê¸°ë³¸ */
button.primary {
  background: var(--accent);
  color: white;
  border: none;
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
button.ghost { background: white; border: 1px solid #ddd; padding: 10px 12px; border-radius:8px; cursor:pointer; }

/* ì •ë‹µ/ì˜¤ë‹µ ìŠ¤íƒ€ì¼ */
.correct { color: green; font-weight: bold; }
.wrong { color: red; font-weight: bold; }

/* ë¯¸ë‹ˆ ëª¨ë“œ ê°•ì¡° */
.mini-mode .question-card,
.mini-mode #answerBox {
  background: #fffbe6 !important;
}

/* ì…ë ¥ë°•ìŠ¤ (ê³„ì‚°ë¬¸ì œ) */
#textAnswerBox, #textAnswerBoxMini {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  box-sizing: border-box;
  font-size: 1rem;
  border-radius: 8px;
  border: 1px solid #ddd;
}

/* ë°˜ì‘í˜• */
@media (max-width: 720px) {
  .controls { flex-direction: column; align-items: stretch; }
  #questionImage { max-height: 260px; }
  body { padding: 10px; }
}
</style>
</head>
<body>
<div class="container">
  <h1>í€´ì¦ˆ ì‹œìŠ¤í…œ</h1>

  <div class="controls">
    <select id="subjectSelect"><option value="">ê³¼ëª© ì„ íƒ</option></select>

    <select id="themeSelect"><option value="">í…Œë§ˆ ì„ íƒ</option></select>

    <!-- ì‚¬ì§„ ì—…ë¡œë“œ(ì„ íƒ) - ë¡œì»¬ ì—…ë¡œë“œë¡œ ë¬¸ì œ ì¶”ê°€í•˜ëŠ” ì˜µì…˜ (ì„ íƒ ì‚¬í•­) -->
    <input type="file" id="photoUpload" webkitdirectory multiple style="display:none;" />
    <button id="uploadBtn" class="ghost" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ) - í´ë” ì„ íƒ ê°€ëŠ¥">ğŸ“ ì‚¬ì§„ ì—…ë¡œë“œ</button>

    <div style="flex:1"></div>

    <button id="miniTestBtn" class="primary">ğŸ”¥ Mini Test (ê³¼ëª©ë³„ 10ë¬¸ì œ)</button>
    <button id="resetBtn" class="ghost" style="display:none;">ğŸ”„ ë¦¬ì…‹</button>
  </div>

  <div id="statusBar"></div>

  <div id="questionArea">
    <!-- ë¬¸ì œ í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°€ëŠ” ì˜ì—­ -->
    <div id="qText" style="font-weight:600; font-size:1.05rem;"></div>
    <img id="questionImage" alt="question image" style="display:none;" />
    <!-- ë³´ê¸° ì˜ì—­ -->
    <div id="optionsArea"></div>

    <!-- ê³„ì‚°/ì£¼ê´€ì‹ ì…ë ¥ -->
    <input id="textAnswerBox" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" style="display:none;" />
    <div style="margin-top:10px;">
      <button id="submitBtn" class="primary" style="display:none;">ì œì¶œ</button>
      <button id="nextBtn" class="ghost">ë‹¤ìŒ ë¬¸ì œ</button>
      <button id="stopBtn" class="ghost" style="display:none;">ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸°</button>
    </div>
  </div>

  <div id="answerBox"></div>
</div>

<script>
/* ============================
   ì „ì²´ í†µí•© ìŠ¤í¬ë¦½íŠ¸
   - ê¸°ì¡´ ë¡œì§ ìœ ì§€
   - photo í…Œë§ˆ ì¶”ê°€ (theme === "photo" ë˜ëŠ” "ì‚¬ì§„")
   - ê³„ì‚° í…Œë§ˆ ì§€ì› (theme === "calc" ë˜ëŠ” "ê³„ì‚°")
   ============================ */

const jsonURL = "https://kangroo1209-alt.github.io/quizquiz/output.json"; // ê¸°ì¡´ JSON ìœ„ì¹˜
let quizData = [];
let currentSubject = "";
let currentTheme = "";
let currentQuestion = null;
let usedQuestions = new Set();

// ì¼ë°˜ ëª¨ë“œ ìƒíƒœ
let solvedCount = 0;
let totalCount = 0;

// ë¯¸ë‹ˆ í…ŒìŠ¤íŠ¸ ìƒíƒœ
let miniMode = false;
let miniList = [];
let miniIndex = 0;
let miniWrong = [];
let miniTotal = 0;

// DOM
const subjectSelect = document.getElementById("subjectSelect");
const themeSelect = document.getElementById("themeSelect");
const questionArea = document.getElementById("questionArea");
const qText = document.getElementById("qText");
const questionImage = document.getElementById("questionImage");
const optionsArea = document.getElementById("optionsArea");
const textAnswerBox = document.getElementById("textAnswerBox");
const submitBtn = document.getElementById("submitBtn");
const nextBtn = document.getElementById("nextBtn");
const resetBtn = document.getElementById("resetBtn");
const statusBar = document.getElementById("statusBar");
const miniTestBtn = document.getElementById("miniTestBtn");
const uploadBtn = document.getElementById("uploadBtn");
const photoUpload = document.getElementById("photoUpload");
const stopBtn = document.getElementById("stopBtn");
const answerBox = document.getElementById("answerBox");

// ì´ë¯¸ì§€ í™•ì¥ì íŒë³„ ì •ê·œì‹
const imageExtRe = /\.(jpg|jpeg|png|gif|bmp|webp)$/i;

// ---------------------------
// ë°ì´í„° ë¡œë“œ
// ---------------------------
fetch(jsonURL)
.then(res => res.json())
.then(data => {
  quizData = data;
  renderSubjects();
})
.catch(err => {
  console.error("JSON ë¡œë“œ ì‹¤íŒ¨:", err);
  // ë¹ˆ quizDataë¡œ ì‹œì‘ ê°€ëŠ¥ (ì—…ë¡œë“œë¡œ ì‚¬ì§„ë§Œ ì¶”ê°€í•˜ê±°ë‚˜)
  quizData = [];
  renderSubjects();
});

// ---------------------------
// ëª¨ë°”ì¼ ë“± UI ê´€ë ¨
// ---------------------------
function applyMiniModeUI(active) {
  if (active) document.body.classList.add("mini-mode");
  else document.body.classList.remove("mini-mode");
}

// ---------------------------
// ê³¼ëª©/í…Œë§ˆ ë Œë”ë§
// ---------------------------
function renderSubjects() {
  const subs = [...new Set(quizData.map(q => q.subject))];
  subjectSelect.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ</option>' + subs.map(s => `<option>${s}</option>`).join("");
}

subjectSelect.addEventListener("change", () => {
  currentSubject = subjectSelect.value;
  renderThemes();
  resetNormal();
});

function renderThemes() {
  if (!currentSubject) {
    themeSelect.innerHTML = '<option value="">í…Œë§ˆ ì„ íƒ</option>';
    return;
  }
  const themes = [...new Set(
    quizData.filter(q => q.subject === currentSubject).map(q => q.theme)
  )];
  themeSelect.innerHTML = '<option value="">í…Œë§ˆ ì„ íƒ</option>' + themes.map(t => `<option>${t}</option>`).join("");
}

themeSelect.addEventListener("change", () => {
  currentTheme = themeSelect.value;
  miniMode = false;
  applyMiniModeUI(false);
  resetNormal();
  renderQuestion();
});

// ---------------------------
// ìƒíƒœë°”
// ---------------------------
function updateStatusBar() {
  if (miniMode) {
    const sub = miniList[miniIndex] ? miniList[miniIndex].subject : "";
    statusBar.innerHTML = `ğŸ”¥ Mini Test ì§„í–‰ ì¤‘<br>ğŸ“˜ í˜„ì¬ ê³¼ëª©: ${sub}<br>â³ ${miniIndex} / ${miniTotal}`;
    return;
  }
  if (currentSubject && currentTheme) {
    statusBar.innerHTML = `ğŸ“˜ ${currentSubject} / ${currentTheme}<br>ğŸ” ${solvedCount} / ${totalCount}`;
    return;
  }
  statusBar.innerHTML = "";
}

// ---------------------------
// ì¼ë°˜ ëª¨ë“œ ë¦¬ì…‹
// ---------------------------
function resetNormal() {
  usedQuestions.clear();
  solvedCount = 0;
  const list = quizData.filter(q => q.subject === currentSubject && q.theme === currentTheme);
  totalCount = list.length;
  updateStatusBar();
  answerBox.innerHTML = "";
  clearQuestionUI();
  resetBtn.style.display = (currentSubject && currentTheme) ? "inline-block" : "none";
}
resetBtn.addEventListener("click", resetNormal);

// ---------------------------
// ì •ë‹µ ì—¬ëŸ¬ê°œ (ê°™ì€ subject+theme ê¸°ì¤€)
// ---------------------------
function getCorrectAnswersFor(qText, subject = currentSubject, theme = currentTheme) {
  return [...new Set(
    quizData.filter(item => item.subject === subject && item.theme === theme && item.question === qText).map(item => item.answer)
  )];
}

// ---------------------------
// ë¬¸ì œ ì¶œì œ (ì¼ë°˜ ëª¨ë“œ)
// ---------------------------
function renderQuestion() {
  if (!currentSubject || !currentTheme) {
    clearQuestionUI();
    qText.innerHTML = "<p>ê³¼ëª©ê³¼ í…Œë§ˆë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>";
    return;
  }

  const list = quizData.filter(q => q.subject === currentSubject && q.theme === currentTheme);
  const remain = list.filter(q => !usedQuestions.has(q.question));

  if (remain.length === 0) {
    clearQuestionUI();
    qText.innerHTML = "<p>ğŸ‰ ëª¨ë“  ë¬¸ì œ ì™„ë£Œ!</p>";
    return;
  }

  const q = remain[Math.floor(Math.random() * remain.length)];
  currentQuestion = q;
  usedQuestions.add(q.question);

  solvedCount++;
  updateStatusBar();

  renderQuestionCard(q);
}

// ì§ˆë¬¸ UI ì´ˆê¸°í™”
function clearQuestionUI() {
  qText.innerHTML = "";
  questionImage.style.display = "none";
  optionsArea.innerHTML = "";
  textAnswerBox.style.display = "none";
  submitBtn.style.display = "none";
}

// ---------------------------
// ë¬¸ì œ ì¹´ë“œ ë Œë”ë§ (í…ìŠ¤íŠ¸/ê°ê´€ì‹/ê³„ì‚°/ì‚¬ì§„ ëª¨ë‘ ì²˜ë¦¬)
// ---------------------------
function renderQuestionCard(q) {
  const correctList = getCorrectAnswersFor(q.question, q.subject, q.theme);
  const mainAnswer = correctList[0];

  // ì´ˆê¸°í™”
  qText.innerHTML = "";
  optionsArea.innerHTML = "";
  questionImage.style.display = "none";
  textAnswerBox.style.display = "none";
  submitBtn.style.display = "none";

  // ì‚¬ì§„ í…Œë§ˆì¸ì§€ íŒë³„: theme ê°’ ìì²´ê°€ "photo" ë˜ëŠ” "ì‚¬ì§„"ì¸ ê²½ìš° ì‚¬ì§„ ëª¨ë“œ
  const themeKey = (q.theme || "").toString().toLowerCase();
  const isPhotoTheme = themeKey === "photo" || themeKey === "ì‚¬ì§„";

  // ê³„ì‚° í…Œë§ˆì¸ì§€ íŒë³„: "calc" ë˜ëŠ” "ê³„ì‚°"
  const isCalcTheme = themeKey === "calc" || themeKey === "ê³„ì‚°";

  // ë§Œì•½ question í•„ë“œ ìì²´ê°€ ì´ë¯¸ì§€ íŒŒì¼ëª… í˜•íƒœë¼ë©´ ì‚¬ì§„ìœ¼ë¡œë„ ì²˜ë¦¬ (backup)
  const isImageFilename = imageExtRe.test((q.question || "").toString());

  if (isPhotoTheme || isImageFilename) {
    // ì‚¬ì§„ ë¬¸ì œ ì²˜ë¦¬
    qText.innerHTML = `<b>ë¬¸ì œ:</b> ì‚¬ì§„ì„ ë³´ê³  ì •ë‹µì„ ê³ ë¥´ì„¸ìš”.`;
    // ì´ë¯¸ì§€ ê²½ë¡œ: images/{subject}/{question}
    const imgPath = `images/${encodeURIComponent(q.subject)}/${encodeURIComponent(q.question)}`;
    questionImage.src = imgPath;
    questionImage.style.display = "block";

    // ë³´ê¸°: ê°™ì€ subject + ê°™ì€ theme ì¤‘ (photo)ì¸ í•­ëª©ì˜ answerë§Œ ì‚¬ìš©
    let candidates = quizData.filter(item =>
      item.subject === q.subject &&
      item.theme === q.theme &&
      item.answer !== mainAnswer // exclude itself answers
    ).map(item => item.answer);

    // ì¤‘ë³µ ì œê±°
    candidates = [...new Set(candidates)];

    // ëœë¤ìœ¼ë¡œ ì˜¤ë‹µ ì„ íƒ (ìµœëŒ€ 4ê°œ)
    let wrongs = [];
    const shuffledCandidates = shuffleArray(candidates);
    for (let i = 0; i < shuffledCandidates.length && wrongs.length < 4; i++) {
      if (shuffledCandidates[i] !== mainAnswer) wrongs.push(shuffledCandidates[i]);
    }

    // ë§Œì•½ í›„ë³´ê°€ ë¶€ì¡±í•˜ë©´ (ë‹¤ë¥¸ í…Œë§ˆ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í•´ë‹¹ subject ë‚´ ë‹¤ë¥¸ themeë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ë³´ì™„)
    if (wrongs.length < 4) {
      const backup = quizData.filter(item => item.subject === q.subject && item.answer !== mainAnswer).map(i=>i.answer);
      const buniq = [...new Set(backup)].filter(x => !wrongs.includes(x) && x !== mainAnswer);
      const bpick = shuffleArray(buniq).slice(0, 4 - wrongs.length);
      wrongs = wrongs.concat(bpick);
    }

    let answers = shuffleArray([mainAnswer, ...wrongs]).slice(0, Math.min(5, 1 + wrongs.length));

    // ë Œë”ë§
    answers.forEach(ans => {
      const div = document.createElement("div");
      div.className = "question-card";
      div.textContent = ans;
      div.onclick = () => {
        showAnswerResult(ans === mainAnswer, mainAnswer, correctList);
      };
      optionsArea.appendChild(div);
    });

    return;
  }

  if (isCalcTheme) {
    // ê³„ì‚° (ì£¼ê´€ì‹)
    qText.innerHTML = `<b>ë¬¸ì œ:</b> ${q.question}`;
    textAnswerBox.style.display = "block";
    submitBtn.style.display = "inline-block";
    submitBtn.onclick = () => {
      const userInput = textAnswerBox.value.trim();
      let isCorrect = compareAnswer(userInput, mainAnswer);
      showAnswerResult(isCorrect, mainAnswer, correctList);
      textAnswerBox.value = "";
    };
    return;
  }

  // ê¸°ë³¸: ê°ê´€ì‹ (ê°™ì€ subject + same theme ë‚´ì—ì„œ ì˜¤ë‹µ ë½‘ê¸°)
  qText.innerHTML = `<b>ë¬¸ì œ:</b> ${q.question}`;

  let others = quizData
    .filter(item => item.subject === q.subject && item.theme === q.theme && item.question !== q.question)
    .map(item => item.answer);

  // ì¤‘ë³µ ì œê±°
  others = [...new Set(others)];

  // ëœë¤ ì„ íƒ
  let picks = [];
  const shuffledOthers = shuffleArray(others);
  for (let i = 0; i < shuffledOthers.length && picks.length < 4; i++) {
    picks.push(shuffledOthers[i]);
  }

  let options = shuffleArray([mainAnswer, ...picks]).slice(0, Math.min(5, 1 + picks.length));
  options.forEach(opt => {
    const div = document.createElement("div");
    div.className = "question-card";
    div.textContent = opt;
    div.onclick = () => {
      showAnswerResult(opt === mainAnswer, mainAnswer, correctList);
    };
    optionsArea.appendChild(div);
  });
}

// ---------------------------
// ì •ë‹µ ê²°ê³¼ ì²˜ë¦¬(show) ë° ë¯¸ë‹ˆ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì²˜ë¦¬
// ---------------------------
function showAnswerResult(isCorrect, mainAnswer, correctList) {
  if (isCorrect) {
    answerBox.innerHTML = `<p class="correct">ì •ë‹µì…ë‹ˆë‹¤!</p><p>ë‹¤ë¥¸ ì •ë‹µë“¤: ${correctList.join(", ")}</p>`;
  } else {
    answerBox.innerHTML = `<p class="wrong">ì˜¤ë‹µì…ë‹ˆë‹¤!</p><p>ì •ë‹µ: ${mainAnswer}</p><p>ë‹¤ë¥¸ ì •ë‹µë“¤: ${correctList.join(", ")}</p>`;
  }

  handleMiniProgress(isCorrect);
}

// ---------------------------
// ì£¼ê´€ì‹/ìˆ«ì ë¹„êµ ìœ í‹¸
// ---------------------------
function compareAnswer(userInput, correct) {
  // ìˆ«ì ë¹„êµ ìš°ì„  (ë‘˜ ë‹¤ ìˆ«ìë¡œ í•´ì„ ê°€ëŠ¥í•˜ë©´ ìˆ«ì ë¹„êµ)
  if (!isNaN(userInput) && !isNaN(correct)) {
    return parseFloat(userInput) === parseFloat(correct);
  }
  // ë¬¸ìì—´ ë¹„êµ: ê³µë°± ì œê±° í›„ ì •í™• ë¹„êµ (ëŒ€ì†Œë¬¸ì ê³ ë ¤: ê·¸ëŒ€ë¡œ)
  return String(userInput).trim() === String(correct).trim();
}

// ---------------------------
// ì¼ë°˜ ë‹¤ìŒ ë¬¸ì œ
// ---------------------------
nextBtn.addEventListener("click", () => {
  if (!miniMode) {
    // ê³„ì‚° ì…ë ¥ì°½ ì—´ë ¤ìˆìœ¼ë©´ ì œì¶œ
    if (textAnswerBox.style.display !== "none" && submitBtn.style.display !== "none") {
      submitBtn.click();
      return;
    }
    renderQuestion();
  }
});

// ---------------------------
// Mini Test ì‹œì‘
// ---------------------------
miniTestBtn.addEventListener("click", startMiniTest);

function startMiniTest() {
  if (!currentSubject) {
    alert("ë¨¼ì € ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  miniMode = true;
  applyMiniModeUI(true);

  nextBtn.style.display = "none";
  stopBtn.style.display = "inline-block";

  usedQuestions.clear();
  miniWrong = [];
  miniIndex = 0;

  miniList = [];
  const subs = [...new Set(quizData.map(q => q.subject))];

  // ê³¼ëª©ë³„ë¡œ 10ê°œì”©(ê°€ëŠ¥í•œ ë§Œí¼) ë½‘ê¸° â€” ê¸°ì¡´ ë¡œì§ì„ ìœ ì§€
  subs.forEach(sub => {
    const pool = quizData.filter(q => q.subject === sub);
    let pick = [];
    while (pick.length < 10 && pool.length > 0) {
      const i = Math.floor(Math.random() * pool.length);
      pick.push(pool[i]);
      pool.splice(i, 1);
    }
    miniList = miniList.concat(pick);
  });

  miniTotal = miniList.length;
  updateStatusBar();
  renderMiniQuestion();
}

function renderMiniQuestion() {
  if (miniIndex >= miniTotal) {
    showMiniResult();
    return;
  }

  const q = miniList[miniIndex];
  currentQuestion = q;

  // ë¯¸ë‹ˆí…ŒìŠ¤íŠ¸ ì¤‘ì—” ë¬¸ì œì˜ ê³¼ëª©/í…Œë§ˆë¥¼ currentë¡œ ì„ì‹œ ì„¸íŒ… (ì¤‘ìš”)
  currentSubject = q.subject;
  currentTheme = q.theme;

  renderQuestionCard(q);
  updateStatusBar();
}

// ---------------------------
// ë¯¸ë‹ˆ í…ŒìŠ¤íŠ¸ ë‹µ ì²˜ë¦¬
// ---------------------------
function handleMiniProgress(isCorrect) {
  if (miniMode) {
    if (!isCorrect) {
      miniWrong.push({
        question: currentQuestion.question,
        myAnswer: "",
        correct: getCorrectAnswersFor(currentQuestion.question, currentQuestion.subject, currentQuestion.theme)
      });
    }
    miniIndex++;
    // ë‹¤ìŒ ë¬¸ì œ ì§§ì€ ì§€ì—° í›„ í‘œì‹œ
    setTimeout(renderMiniQuestion, 400);
  }
}

// ---------------------------
// ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸° (ë¯¸ë‹ˆí…ŒìŠ¤íŠ¸ ì¤‘)
// ---------------------------
stopBtn.addEventListener("click", () => {
  miniMode = false;
  applyMiniModeUI(false);
  showMiniResult();
});

// ---------------------------
// Mini Test ê²°ê³¼ í‘œì‹œ (í‘¼ ë¬¸ì œ ê¸°ì¤€)
// ---------------------------
function showMiniResult() {
  nextBtn.style.display = "inline-block";
  stopBtn.style.display = "none";

  const totalSolved = miniIndex; // ë¯¸ë‹ˆí…ŒìŠ¤íŠ¸ ì¤‘ í‘¼ ë¬¸ì œ ìˆ˜
  const wrongCountLocal = miniWrong.length;
  const correctCountLocal = totalSolved - wrongCountLocal;

  let html = `<h2>Mini Test ì™„ë£Œ!</h2>`;
  html += `<p>ì´ í‘¼ ë¬¸ì œ: ${totalSolved}</p>`;
  html += `<p>ì •ë‹µ: ${correctCountLocal}</p>`;
  html += `<p>ì˜¤ë‹µ: ${wrongCountLocal}</p>`;

  if (wrongCountLocal > 0) {
    html += `<h3>í‹€ë¦° ë¬¸ì œë“¤</h3>`;
    miniWrong.forEach(w => {
      html += `<p><b>${w.question}</b><br>ì •ë‹µ: ${w.correct.join(", ")}</p><hr>`;
    });
  }

  // ê²°ê³¼ëŠ” questionAreaë¡œ ì¶œë ¥
  qText.innerHTML = html;
  questionImage.style.display = "none";
  optionsArea.innerHTML = "";
  answerBox.innerHTML = "";
  statusBar.innerHTML = "";
  applyMiniModeUI(false);
}

// ---------------------------
// íŒŒì¼ ì—…ë¡œë“œ(ë¡œì»¬ ì´ë¯¸ì§€ í´ë”)ë¡œ ì‚¬ì§„ ë¬¸ì œ ì¶”ê°€ (ì„ íƒ ê¸°ëŠ¥)
// ---------------------------
uploadBtn.addEventListener("click", () => {
  // í´ë” ì—…ë¡œë“œ input íŠ¸ë¦¬ê±°
  photoUpload.click();
});

photoUpload.addEventListener("change", (ev) => {
  const files = Array.from(ev.target.files || []);
  const images = files.filter(f => f.type && f.type.startsWith("image/"));

  if (images.length === 0) {
    alert("ì´ë¯¸ì§€ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  // ì—…ë¡œë“œëœ íŒŒì¼ë“¤ë¡œ quizDataì— ë¬¸ì œ ì¶”ê°€
  // íŒŒì¼ ê²½ë¡œ(webkitdirectory ì‚¬ìš©ì‹œ)ì—ì„œ í´ë” êµ¬ì¡°ë¥¼ ì½ì–´ subjectë¡œ ì‚¬ìš©
  images.forEach(file => {
    // file.webkitRelativePath ì˜ˆ: "ê³¼ì¼/apple.jpg" ë˜ëŠ” "ê³¼ì¼\\apple.jpg"
    const rel = file.webkitRelativePath || file.name;
    // normalize path separators
    const parts = rel.split(/\/|\\/).filter(Boolean);
    let subjectFromPath = currentSubject || "ì—…ë¡œë“œ";
    let filename = file.name;

    if (parts.length >= 2) {
      subjectFromPath = parts[0];
      filename = parts[parts.length - 1];
    }

    const nameNoExt = filename.replace(/\.[^/.]+$/, "");

    // create object URL so it can be previewed locally (note: this is temporary and for local preview only)
    const url = URL.createObjectURL(file);

    // Push as a quiz item â€” theme set to "photo" and question stores the filename.
    quizData.push({
      subject: subjectFromPath,
      theme: "photo",
      question: filename,
      answer: nameNoExt,
      __local_url: url // optional: for local preview if you want (code uses images/{subject}/{question} by default)
    });
  });

  // ì¬ë Œë”ë§
  renderSubjects();
  alert(`${images.length}ê°œì˜ ì‚¬ì§„ ë¬¸ì œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë‚´ ì„ì‹œ ì¶”ê°€)`);
});

// ---------------------------
// ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ ë° ì§„í–‰ íë¦„ ë³´ì¡° ìœ í‹¸
// ---------------------------
function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ============================
   ì´ˆê¸° í˜¸ì¶œ ìœ ë„: (ì„ íƒ)
   - í˜ì´ì§€ ë¡œë“œ í›„ ì‚¬ìš©ìê°€ ê³¼ëª©/í…Œë§ˆ ì„ íƒí•˜ë©´ renderQuestion íŠ¸ë¦¬ê±°
   ============================ */

// ì„ íƒì„ ë°”ê¾¸ë©´ ìë™ìœ¼ë¡œ renderQuestion í˜¸ì¶œë˜ë„ë¡ ì´ë¯¸ ì„¤ì •ë¨.
// ë‹¨, ì²˜ìŒ ë°ì´í„°ê°€ ë¡œë“œëœ í›„ ë°”ë¡œ ê³¼ëª©/í…Œë§ˆê°€ ë¹„ì–´ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ìê°€ ì„ íƒí•´ì•¼ í•¨.

</script>
</body>
</html>
