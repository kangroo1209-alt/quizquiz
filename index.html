<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í€´ì¦ˆ ì‹œìŠ¤í…œ</title>
<style>
body { font-family: Arial; margin: 20px; }
h1 { margin-bottom: 10px; }
select, button { padding: 8px; margin-right: 10px; }
#questionArea { margin-top: 20px; }
.question-card {
    border: 1px solid #ccc; padding: 10px; margin-bottom: 5px; cursor: pointer;
    background: white;
}
.question-card:hover { background: #f0f0f0; }
#answerBox { margin-top: 20px; padding: 10px; border: 1px solid #444; background: #fafafa; }
#nextBtn { margin-top: 10px; padding: 8px 16px; }
.correct { color: green; font-weight: bold; }
.wrong { color: red; font-weight: bold; }
.menuBar { margin-bottom: 20px; }

/* ë¯¸ë‹ˆí…ŒìŠ¤íŠ¸ ë°°ê²½ */
.mini-mode .question-card { background: #fffce6; }

/* ë¦¬ì…‹ ë²„íŠ¼ */
#resetBtn {
    padding: 6px 12px;
    margin-left: 10px;
    background-color: #ff4d4d;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
}
#resetBtn:hover { background-color: #e60000; }

/* ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸° ë²„íŠ¼ */
#stopMiniBtn {
    padding: 6px 12px;
    background-color: #ff9900;
    color: black;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 15px;
}
#stopMiniBtn:hover { background-color: #e67e00; }

</style>
</head>
<body>

<h1>í€´ì¦ˆ ì‹œìŠ¤í…œ</h1>

<div class="menuBar">
    <button id="miniTestBtn">ğŸ”¥ Mini Test (ê° ê³¼ëª© 10ë¬¸ì œ)</button>
    <button id="resetBtn">ë¦¬ì…‹</button>
</div>

<select id="subjectSelect">
    <option value="">ê³¼ëª© ì„ íƒ</option>
</select>

<select id="themeSelect">
    <option value="">í…Œë§ˆ ì„ íƒ</option>
</select>

<p id="progressText"></p>

<!-- ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸° ë²„íŠ¼: ë¬¸ì œë³´ë‹¤ ìœ„ì— í‘œì‹œ -->
<button id="stopMiniBtn" style="display:none;">ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸° ã… ã… </button>

<div id="questionArea"></div>

<div id="answerInputArea"></div>

<button id="nextBtn">ë‹¤ìŒ ë¬¸ì œ</button>

<div id="answerBox"></div>

<script>
const jsonURL = "https://kangroo1209-alt.github.io/quizquiz/output.json";

let quizData = [];
let currentSubject = "";
let currentTheme = "";
let currentQuestion = null;
let currentAnswers = [];
let usedQuestions = new Set();

let miniMode = false;
let miniList = [];
let miniIndex = 0;
let miniWrong = [];
let miniSubjects = [];

// HTML elements
const subjectSelect = document.getElementById("subjectSelect");
const themeSelect = document.getElementById("themeSelect");
const questionArea = document.getElementById("questionArea");
const answerBox = document.getElementById("answerBox");
const nextBtn = document.getElementById("nextBtn");
const miniTestBtn = document.getElementById("miniTestBtn");
const stopMiniBtn = document.getElementById("stopMiniBtn");
const resetBtn = document.getElementById("resetBtn");
const answerInputArea = document.getElementById("answerInputArea");
const progressText = document.getElementById("progressText");

/* --------------------------
      JSON LOAD
---------------------------*/
fetch(jsonURL)
.then(res => res.json())
.then(data => {
    quizData = data;
    renderSubjects();
});

/* --------------------------
      SUBJECT / THEME
---------------------------*/
function renderSubjects() {
    const subjects = [...new Set(quizData.map(q => q.subject))];
    miniSubjects = subjects;

    subjectSelect.innerHTML =
        '<option value="">ê³¼ëª© ì„ íƒ</option>' +
        subjects.map(s => `<option value="${s}">${s}</option>`).join("");
}

subjectSelect.addEventListener("change", () => {
    currentSubject = subjectSelect.value;
    renderThemes();
    usedQuestions.clear();
    updateProgress();
    answerBox.innerHTML = "";
    answerInputArea.innerHTML = "";
});

function renderThemes() {
    const themes = [...new Set(
        quizData.filter(q => q.subject === currentSubject).map(q => q.theme)
    )];

    themeSelect.innerHTML =
        '<option value="">í…Œë§ˆ ì„ íƒ</option>' +
        themes.map(t => `<option value="${t}">${t}</option>`).join("");
}

themeSelect.addEventListener("change", () => {
    currentTheme = themeSelect.value;
    miniMode = false;
    document.body.classList.remove("mini-mode");
    renderQuestion();
});

/* --------------------------
      ì—¬ëŸ¬ ì •ë‹µ ì§€ì›
---------------------------*/
function getCorrectAnswers(qtext) {
    return [...new Set(
        quizData.filter(q => q.question === qtext).map(q => q.answer)
    )];
}

/* --------------------------
      ìˆ«ì í¬ë§·íŒ…
---------------------------*/
function normalizeNumber(str) {
    if (!str) return null;
    str = str.trim();
    str = str.replace(/,/g, "");
    str = str.replace(/[a-zA-Z%]+/g, "");
    if (str.startsWith(".")) str = "0" + str;

    let val = Number(str);
    return isNaN(val) ? null : val;
}

/* --------------------------
      ë¬¸ì œ ëœë¤ ì¶œì œ
---------------------------*/
function renderQuestion() {
    answerInputArea.innerHTML = "";
    answerBox.innerHTML = "";

    if (!currentSubject || !currentTheme) {
        questionArea.innerHTML = "<p>ê³¼ëª©ê³¼ í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>";
        return;
    }

    const filtered = quizData.filter(
        q => q.subject === currentSubject && q.theme === currentTheme
    );

    const candidates = filtered.filter(q => !usedQuestions.has(q.question));

    if (candidates.length === 0) {
        questionArea.innerHTML = "<p>ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤.</p>";
        return;
    }

    const q = candidates[Math.floor(Math.random() * candidates.length)];
    currentQuestion = q;
    usedQuestions.add(q.question);

    renderQuestionCard(q);
    updateProgress();
}

/* --------------------------
      ë¬¸ì œ ì¹´ë“œ ì¶œë ¥
---------------------------*/
function renderQuestionCard(q) {
    const correctAnswers = getCorrectAnswers(q.question);
    questionArea.innerHTML =
        `<div class="question-card"><b>ë¬¸ì œ:</b> ${q.question}</div>`;

    // ê³„ì‚° ë¬¸ì œ â†’ ì£¼ê´€ì‹
    if (q.theme === "ê³„ì‚°") {
        renderCalcInput(correctAnswers);
        return;
    }

    let answers = [correctAnswers[0]];

    let others = quizData.filter(
        item => item.subject === q.subject && item.theme === q.theme
    )
    .map(item => item.answer)
    .filter(a => !correctAnswers.includes(a));

    while (answers.length < 5 && others.length > 0) {
        let idx = Math.floor(Math.random() * others.length);
        answers.push(others[idx]);
        others.splice(idx, 1);
    }

    answers = answers.sort(() => Math.random() - 0.5);
    currentAnswers = answers;

    answers.forEach((ans, i) => {
        questionArea.innerHTML += `
            <div class="question-card" onclick="checkAnswer('${ans.replace(/'/g,"&#39;")}')">
                ${i + 1}. ${ans}
            </div>`;
    });
}

/* --------------------------
      ê³„ì‚° ë¬¸ì œ ì…ë ¥ì°½
---------------------------*/
function renderCalcInput(correctAnswers) {
    answerInputArea.innerHTML = `
        <input id="calcInput" type="text" placeholder="ì •ë‹µ ì…ë ¥" style="padding:5px;">
        <button id="submitCalcBtn">ì œì¶œ</button>
    `;

    // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° â†’ ì²« ì œì¶œ ì˜¤ë¥˜ ë°©ì§€
    const btn = document.getElementById("submitCalcBtn");
    btn.addEventListener("click", () => {
        checkCalcAnswer(correctAnswers);
    });
}

function checkCalcAnswer(correctAnswers) {
    let userInput = document.getElementById("calcInput").value;
    let userVal = normalizeNumber(userInput);
    let answerVal = normalizeNumber(correctAnswers[0]);

    if (userVal === answerVal) {
        answerBox.innerHTML = `<p class="correct">ì •ë‹µì…ë‹ˆë‹¤!</p>
            <p>ë‹¤ë¥¸ ì •ë‹µë“¤: ${correctAnswers.join(", ")}</p>`;
    } else {
        answerBox.innerHTML = `<p class="wrong">ì˜¤ë‹µì…ë‹ˆë‹¤!</p>
            <p>ì •ë‹µ: ${correctAnswers.join(", ")}</p>`;
    }

    if (miniMode) processMiniAnswer(userInput, correctAnswers);
}

/* --------------------------
      ê°ê´€ì‹ ì •ë‹µ ì²´í¬
---------------------------*/
window.checkAnswer = (ans) => {
    const correctAnswers = getCorrectAnswers(currentQuestion.question);

    if (ans === correctAnswers[0]) {
        answerBox.innerHTML = `<p class="correct">ì •ë‹µì…ë‹ˆë‹¤!</p>
        <p>ë‹¤ë¥¸ ì •ë‹µë“¤: ${correctAnswers.join(", ")}</p>`;
    } else {
        answerBox.innerHTML = `<p class="wrong">ì˜¤ë‹µ!</p>
        <p>ì •ë‹µ: ${correctAnswers.join(", ")}</p>`;
    }

    if (miniMode) processMiniAnswer(ans, correctAnswers);
};

/* --------------------------
      NEXT ë²„íŠ¼
---------------------------*/
nextBtn.addEventListener("click", () => {
    if (!miniMode) renderQuestion();
});

/* --------------------------
      RESET
---------------------------*/
resetBtn.addEventListener("click", () => {
    usedQuestions.clear();
    miniMode = false;
    miniWrong = [];
    answerBox.innerHTML = "";
    answerInputArea.innerHTML = "";
    questionArea.innerHTML = "";
    progressText.innerHTML = "";
    nextBtn.style.display = "inline-block";
    stopMiniBtn.style.display = "none";
    document.body.classList.remove("mini-mode");
});

/* --------------------------
      MINI TEST
---------------------------*/
miniTestBtn.addEventListener("click", startMiniTest);

function startMiniTest() {
    miniMode = true;
    miniWrong = [];
    miniIndex = 0;
    document.body.classList.add("mini-mode");

    nextBtn.style.display = "none";      // â† next ë²„íŠ¼ ìˆ¨ê¹€
    stopMiniBtn.style.display = "inline-block";

    miniList = [];

    miniSubjects.forEach(sub => {
        let pool = quizData.filter(q => q.subject === sub);
        let selected = [];

        while (selected.length < 10 && pool.length > 0) {
            let idx = Math.floor(Math.random() * pool.length);
            selected.push(pool[idx]);
            pool.splice(idx, 1);
        }
        miniList.push(...selected);
    });

    renderMiniQuestion();
}

function renderMiniQuestion() {
    if (miniIndex >= miniList.length) {
        showMiniResult();
        return;
    }

    const q = miniList[miniIndex];
    currentQuestion = q;

    currentSubject = q.subject;
    currentTheme = q.theme;

    renderQuestionCard(q);
    updateProgress(true);
}

stopMiniBtn.addEventListener("click", showMiniResult);

function processMiniAnswer(userAnswer, correctAnswers) {
    if (normalizeNumber(userAnswer) !== normalizeNumber(correctAnswers[0])) {
        miniWrong.push({
            question: currentQuestion.question,
            myAnswer: userAnswer,
            correct: correctAnswers
        });
    }

    miniIndex++;
    setTimeout(renderMiniQuestion, 700);
}

function showMiniResult() {
    miniMode = false;
    document.body.classList.remove("mini-mode");

    nextBtn.style.display = "inline-block";
    stopMiniBtn.style.display = "none";

    let score = miniList.length - miniWrong.length;

    let html = `<h2>Mini Test ê²°ê³¼</h2>`;
    html += `<p><b>${miniList.length}ë¬¸ì œ ì¤‘ ${score}ê°œ ì •ë‹µ</b></p>`;

    if (miniWrong.length > 0) {
        html += `<h3>í‹€ë¦° ë¬¸ì œ</h3>`;
        miniWrong.forEach(w => {
            html += `
            <div style="margin-bottom:10px;">
                <b>ë¬¸ì œ:</b> ${w.question}<br>
                <b>ë‚´ ë‹µ:</b> ${w.myAnswer}<br>
                <b>ì •ë‹µ:</b> ${w.correct.join(", ")}
            </div>`;
        });
    } else {
        html += `<p>ì „ë¶€ ì •ë‹µì…ë‹ˆë‹¤! ì™„ë²½!</p>`;
    }

    questionArea.innerHTML = html;
    answerInputArea.innerHTML = "";
    answerBox.innerHTML = "";
    progressText.innerHTML = "";
}

/* --------------------------
      PROGRESS
---------------------------*/
function updateProgress(isMini = false) {
    if (isMini) {
        progressText.innerHTML = `
            <b>Mini Test</b><br>
            í˜„ì¬ ê³¼ëª©: ${miniList[miniIndex]?.subject || ""}<br>
            ${miniIndex} / ${miniList.length} ë¬¸ì œ í’€ìŒ
        `;
    } else {
        const count = quizData.filter(
            q => q.subject === currentSubject && q.theme === currentTheme
        ).length;

        progressText.innerHTML =
            `${usedQuestions.size} / ${count} ë¬¸ì œ í’€ìŒ`;
    }
}
</script>
</body>
</html>





