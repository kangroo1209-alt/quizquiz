<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>í€´ì¦ˆ ì‹œìŠ¤í…œ - ë””ë²„ê·¸ ë²„ì „</title>
<style>
body{font-family:Arial;margin:18px}
select,button{padding:8px;margin:6px}
#questionArea{margin-top:16px;padding:10px;border-radius:8px}
.question-card{border:1px solid #ccc;padding:10px;margin-bottom:6px;cursor:pointer;border-radius:6px}
.question-card:hover{background:#f0f0f0}
.correct{color:green;font-weight:bold}
.wrong{color:red;font-weight:bold}
#answerBox{margin-top:12px;padding:10px;border:1px solid #444;background:#fafafa;border-radius:6px}
#status{margin-top:12px;color:#444}
#errorBox{margin-top:12px;color:#b00;font-weight:bold}
</style>
</head>
<body>

<h2>í€´ì¦ˆ ì‹œìŠ¤í…œ (ë””ë²„ê·¸)</h2>

<!-- ìœ ì¼í•œ subjectSelectì™€ themeSelectë¥¼ ë³´ì¥ -->
<select id="subjectSelect"><option value="">ê³¼ëª© ì„ íƒ</option></select>
<select id="themeSelect"><option value="">í…Œë§ˆ ì„ íƒ</option></select>

<button id="nextBtn">ë‹¤ìŒ ë¬¸ì œ</button>
<button id="miniTestBtn">Mini Test</button>
<button id="resetBtn" style="background:#e66;color:#fff">ë¦¬ì…‹</button>

<p id="miniModeLabel"></p>
<p id="progressText"></p>

<div id="questionArea"></div>
<div id="answerBox"></div>

<div id="status"></div>
<div id="errorBox"></div>

<script>
/* ====== ì„¤ì • ë¶€ë¶„: JSON URLë“¤ì„ ì—¬ê¸°ì„œ í™•ì¸í•˜ì„¸ìš” ======
   - ì‹¤ì œ ì—…ë¡œë“œí•˜ì‹  URLì´ quizyquizì¸ì§€ quizquizì¸ì§€ ì •í™•íˆ ê¸°ì…í•´ì•¼ í•©ë‹ˆë‹¤.
   - ì•„ë˜ì— í›„ë³´ URLì„ ë„£ì–´ë‘ì—ˆìŠµë‹ˆë‹¤. ìˆœì„œëŒ€ë¡œ ì‹œë„í•©ë‹ˆë‹¤.
*/
const jsonCandidates = [
    "https://kangroo1209-alt.github.io/quizyquiz/output.json", // ì›ë˜ ì“°ë˜ ê²ƒ
    "https://kangroo1209-alt.github.io/quizquiz/output.json",  // ì˜¤íƒ€ ê°€ëŠ¥ì„±
    // í•„ìš”í•˜ë©´ ë” ì¶”ê°€
];

let quizData = [];
let currentSubject = "";
let currentTheme = "";
let currentQuestion = null;
let usedQuestions = new Set();
let miniMode = false, miniList = [], miniIndex = 0, miniWrong = [];

// DOM ë ˆí¼ëŸ°ìŠ¤
const subjectSelect = document.getElementById("subjectSelect");
const themeSelect   = document.getElementById("themeSelect");
const questionArea  = document.getElementById("questionArea");
const answerBox     = document.getElementById("answerBox");
const nextBtn       = document.getElementById("nextBtn");
const miniTestBtn   = document.getElementById("miniTestBtn");
const resetBtn      = document.getElementById("resetBtn");
const progressText  = document.getElementById("progressText");
const miniModeLabel = document.getElementById("miniModeLabel");
const statusDiv     = document.getElementById("status");
const errorBox      = document.getElementById("errorBox");

// ===== ì¤‘ë³µ id ì •ë¦¬: ë™ì¼ idê°€ 2ê°œ ì´ìƒì´ë©´ ì²«ë²ˆì§¸ë§Œ ë‚¨ê¸°ê³  ì œê±° =====
function dedupeElementById(id){
    const nodes = document.querySelectorAll(`#${id}`);
    if(nodes.length > 1){
        console.warn(`ì¤‘ë³µëœ id="${id}" ìš”ì†Œ ${nodes.length}ê°œ ë°œê²¬. ë‚˜ë¨¸ì§€ ì œê±°í•©ë‹ˆë‹¤.`);
        for(let i=1;i<nodes.length;i++){
            nodes[i].remove();
        }
    }
}
dedupeElementById("subjectSelect");
dedupeElementById("themeSelect");

// ===== fetch with fallback + good logging =====
async function loadJsonWithFallback(candidates){
    let lastErr = null;
    statusDiv.textContent = "ë°ì´í„° ë¡œë“œ ì‹œë„ ì¤‘...";
    for(const url of candidates){
        try {
            console.log("ì‹œë„ ì¤‘ URL:", url);
            statusDiv.textContent = `ë¡œë”©: ${url}`;
            const res = await fetch(url, {cache: "no-store"});
            if(!res.ok){
                // 404 ë“±
                lastErr = new Error(`HTTP ${res.status} ${res.statusText} from ${url}`);
                console.error(lastErr);
                continue;
            }
            const data = await res.json();
            // ê°„ë‹¨ ê²€ì¦: ë°°ì—´ì¸ì§€, ìµœì†Œ í•œ ê°œì˜ objectê°€ subject í•„ë“œ ê°–ëŠ”ì§€
            if(!Array.isArray(data)){
                lastErr = new Error("íŒŒì¼ì´ JSON ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
                console.error(lastErr, data);
                continue;
            }
            if(data.length === 0){
                console.warn("JSON íŒŒì¼ì€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
            }
            console.log(`ì„±ê³µ: ${url} (items: ${data.length})`);
            statusDiv.textContent = `ë°ì´í„° ë¡œë“œ ì„±ê³µ: ${url} (ê°œìˆ˜ ${data.length})`;
            return {data, url};
        } catch(e){
            console.error("fetch ì‹¤íŒ¨:", url, e);
            lastErr = e;
        }
    }
    // ëª¨ë“  í›„ë³´ ì‹¤íŒ¨
    throw lastErr || new Error("ëª¨ë“  ì‹œë„ ì‹¤íŒ¨");
}

// ë°”ë¡œ ë¡œë”© ì‹œë„
loadJsonWithFallback(jsonCandidates)
.then(({data, url})=>{
    // ê¸°ë³¸ ì „ì²˜ë¦¬: BOM ì œê±°, trim ë“±
    quizData = data.map(q=>({
        subject: String(q.subject||"").replace(/^\uFEFF/,"").trim(),
        theme:   String(q.theme||"").replace(/^\uFEFF/,"").trim(),
        question:String(q.question||"").trim(),
        answer:  String(q.answer||"").toString().trim()
    }));
    console.log("ì •ë¦¬ëœ ë°ì´í„° ì˜ˆì‹œ:", quizData.slice(0,3));
    renderSubjects();
})
.catch(err=>{
    console.error("ëª¨ë“  URL ë¡œë“œ ì‹¤íŒ¨:", err);
    statusDiv.textContent = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
    errorBox.innerHTML = `
        JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>
        ê°€ëŠ¥í•œ ì›ì¸: URL ì˜¤íƒ€, CORS(ì„œë²„ì—ì„œ ì™¸ë¶€ ìš”ì²­ ì°¨ë‹¨), íŒŒì¼ì´ ì—†ê±°ë‚˜ JSON í˜•ì‹ ì˜¤ë¥˜.<br>
        ì½˜ì†”(F12) í™•ì¸ í›„ URLì„ ê²€í† í•˜ì„¸ìš”.<br>
        ì‹œë„í•œ URL: <pre>${jsonCandidates.join("\n")}</pre>
        <hr>
        ì˜¤ë¥˜ ë©”ì‹œì§€: ${err && err.message ? err.message : String(err)}
    `;
});

// ===== UI ë Œë” í•¨ìˆ˜ë“¤ (ì›ë³¸ê³¼ ë™ì¼í•˜ë˜ ì•ˆì •ì„± ë³´ê°•) =====
function renderSubjects(){
    // subjectê°€ ë¹ˆ ë¬¸ìì—´ì´ ë“¤ì–´ìˆëŠ” ê²½ìš° ì œê±°
    const subjects = [...new Set(quizData.map(q=>q.subject).filter(s=>s && s.trim() !== ""))];
    subjectSelect.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ</option>' + subjects.map(s=>`<option value="${s}">${s}</option>`).join("");
    questionArea.innerHTML = "<p>ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>";
}

subjectSelect.addEventListener("change", () => {
    currentSubject = subjectSelect.value;
    usedQuestions.clear();
    answerBox.innerHTML = "";
    progressText.innerHTML = "";
    miniMode = false;
    miniModeLabel.innerHTML = "";
    renderThemes();
});

function renderThemes(){
    if(!currentSubject){
        themeSelect.innerHTML = '<option value="">í…Œë§ˆ ì„ íƒ</option>';
        return;
    }
    const themes = [...new Set(quizData.filter(q=>q.subject===currentSubject).map(q=>q.theme).filter(t=>t && t.trim() !== ""))];
    themeSelect.innerHTML = '<option value="">í…Œë§ˆ ì„ íƒ</option>' + themes.map(t=>`<option value="${t}">${t}</option>`).join("");
}

themeSelect.addEventListener("change", () => {
    currentTheme = themeSelect.value;
    usedQuestions.clear();
    miniMode = false;
    miniModeLabel.innerHTML = "";
    renderQuestion();
});

function renderQuestion(){
    if(!currentSubject || !currentTheme){
        questionArea.innerHTML = "<p>ê³¼ëª©ê³¼ í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>";
        return;
    }
    const filtered = quizData.filter(q=>q.subject===currentSubject && q.theme===currentTheme);
    const candidates = filtered.filter(q=>!usedQuestions.has(q.question));
    if(candidates.length === 0){
        questionArea.innerHTML = "<p>ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤.</p>";
        return;
    }
    const q = candidates[Math.floor(Math.random()*candidates.length)];
    currentQuestion = q;
    usedQuestions.add(q.question);
    updateProgress(filtered.length);
    renderQuestionCard(q);
}

function getCorrectAnswers(questionText){
    return [...new Set( quizData.filter(q=>q.question===questionText).map(q=>q.answer) )];
}

function renderQuestionCard(q){
    const correctAnswers = getCorrectAnswers(q.question);
    const mainAnswer = correctAnswers[0]||"";

    if(currentTheme === "ê³„ì‚°"){
        questionArea.style.background = "#fff6d1";
        questionArea.innerHTML = `<div class="question-card"><b>ë¬¸ì œ:</b> ${q.question}</div>
            <input id="shortAnswer" type="text" placeholder="ì •ë‹µ ì…ë ¥" style="padding:8px;margin-top:10px;width:220px;">
            <button onclick="checkShortAnswer()" style="padding:8px 12px;margin-left:8px">í™•ì¸</button>`;
        answerBox.innerHTML = "";
        return;
    }

    let answers = [mainAnswer];
    const sameTheme = quizData.filter(item => item.subject === currentSubject && item.theme === currentTheme);
    let otherAnswers = sameTheme.map(i=>i.answer).filter(a=>!correctAnswers.includes(a));
    while(answers.length < 5 && otherAnswers.length > 0){
        const idx = Math.floor(Math.random()*otherAnswers.length);
        answers.push(otherAnswers[idx]);
        otherAnswers.splice(idx,1);
    }
    while(answers.length < 5) answers.push("ë³´ê¸° ì—†ìŒ");
    answers = answers.sort(()=>Math.random()-0.5);

    questionArea.style.background = "white";
    questionArea.innerHTML = `<div class="question-card"><b>ë¬¸ì œ:</b> ${q.question}</div>`;
    answers.forEach((ans,i)=>{
        questionArea.innerHTML += `<div class="question-card" onclick="checkAnswer('${ans.replace(/'/g,"&#39;")}')">${i+1}. ${ans}</div>`;
    });
    answerBox.innerHTML = "";
}

window.checkAnswer = (ans)=>{
    if(!currentQuestion){ return; }
    const correctAnswers = getCorrectAnswers(currentQuestion.question);
    const mainAnswer = correctAnswers[0]||"";
    if(ans === mainAnswer){
        answerBox.innerHTML = `<p class="correct">ì •ë‹µì…ë‹ˆë‹¤!</p><p>ì •ë‹µ ëª©ë¡: ${correctAnswers.join(", ")}</p>`;
    } else {
        answerBox.innerHTML = `<p class="wrong">ì˜¤ë‹µì…ë‹ˆë‹¤!</p><p>ì •ë‹µ: ${mainAnswer}</p><p>ì •ë‹µ ëª©ë¡: ${correctAnswers.join(", ")}</p>`;
    }
    if(miniMode){
        if(ans !== mainAnswer){
            miniWrong.push({question: currentQuestion.question, myAnswer: ans, correct: correctAnswers});
        }
        miniIndex++;
        setTimeout(renderMiniQuestion, 600);
    }
};

function checkShortAnswer(){
    const input = (document.getElementById("shortAnswer")||{value:""}).value.trim();
    if(!currentQuestion) return;
    const correct = getCorrectAnswers(currentQuestion.question).map(v=>v.toString().trim());
    if(correct.includes(input)){
        answerBox.innerHTML = `<p class="correct">ì •ë‹µì…ë‹ˆë‹¤!</p><p>ì •ë‹µ ëª©ë¡: ${correct.join(", ")}</p>`;
    } else {
        answerBox.innerHTML = `<p class="wrong">ì˜¤ë‹µì…ë‹ˆë‹¤!</p><p>ì •ë‹µë“¤: ${correct.join(", ")}</p>`;
    }
    if(miniMode){
        if(!correct.includes(input)) miniWrong.push({question: currentQuestion.question, myAnswer: input, correct});
        miniIndex++;
        setTimeout(renderMiniQuestion, 600);
    }
}

nextBtn.addEventListener("click", ()=>{ if(!miniMode) renderQuestion(); });

resetBtn.addEventListener("click", ()=>{
    usedQuestions.clear();
    miniMode=false; miniModeLabel.innerHTML="";
    answerBox.innerHTML=""; questionArea.innerHTML=""; progressText.innerHTML="";
});

miniTestBtn.addEventListener("click", startMiniTest);

function startMiniTest(){
    if(quizData.length === 0){
        alert("ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }
    miniMode=true; usedQuestions.clear(); miniWrong=[]; miniIndex=0;
    miniModeLabel.innerHTML = "<b>ğŸ”¥ Mini Test ì§„í–‰ì¤‘</b>";
    const subjects = [...new Set(quizData.map(q=>q.subject).filter(s=>s && s.trim() !== ""))];
    miniList = [];
    subjects.forEach(sub=>{
        const subjectQuestions = quizData.filter(q=>q.subject===sub);
        let pool = [...subjectQuestions], selected=[];
        while(selected.length < 10 && pool.length > 0){
            const idx = Math.floor(Math.random()*pool.length);
            selected.push(pool[idx]); pool.splice(idx,1);
        }
        miniList = miniList.concat(selected);
    });
    renderMiniQuestion();
}

function renderMiniQuestion(){
    if(miniIndex >= miniList.length) return showMiniResult();
    const q = miniList[miniIndex];
    currentQuestion = q;
    questionArea.style.background = "#fff7da";
    progressText.innerHTML = `Mini Test: ${miniIndex+1} / ${miniList.length} <br>í˜„ì¬ ê³¼ëª©: <b>${q.subject}</b>`;
    renderQuestionCard(q);
}

function showMiniResult(){
    miniMode=false; miniModeLabel.innerHTML="";
    const score = miniList.length - miniWrong.length;
    let html = `<h3>Mini Test ì™„ë£Œ</h3><p>ì´: ${miniList.length}, ì •ë‹µ: ${score}, ì˜¤ë‹µ: ${miniWrong.length}</p>`;
    if(miniWrong.length>0){
        html += "<h4>í‹€ë¦° ë¬¸ì œ</h4>";
        miniWrong.forEach(w=>{
            html += `<div class="question-card"><b>ë¬¸ì œ:</b>${w.question}<br><b>ë‚´ ë‹µ:</b>${w.myAnswer}<br><b>ì •ë‹µ:</b>${w.correct.join(", ")}</div>`;
        });
    }
    questionArea.innerHTML = html;
}

function updateProgress(total){ progressText.innerHTML = `ì§„í–‰ë¥ : ${usedQuestions.size} / ${total}`; }

</script>
</body>
</html>



